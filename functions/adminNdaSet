import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    
    const user = await base44.auth.me();
    if (!user) {
      return Response.json({
        ok: false,
        error: "not_authenticated"
      }, {
        status: 401,
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-store'
        }
      });
    }

    // Check admin role
    const profiles = await base44.entities.Profile.filter({ email: user.email });
    if (profiles.length === 0 || profiles[0].role !== 'admin') {
      return Response.json({
        ok: false,
        error: "forbidden"
      }, {
        status: 403,
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-store'
        }
      });
    }

    // Parse body
    let body = {};
    try {
      const contentType = req.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        body = await req.json();
      } else {
        const text = await req.text();
        body = Object.fromEntries(new URLSearchParams(text));
      }
    } catch (e) {
      // Empty body
    }

    const { userId, accepted } = body;
    
    if (!userId || typeof accepted === 'undefined') {
      return Response.json({
        ok: false,
        error: "missing_params"
      }, {
        status: 400,
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-store'
        }
      });
    }

    // Find target profile
    const targetProfiles = await base44.asServiceRole.entities.Profile.filter({ 
      user_id: userId 
    });
    
    if (targetProfiles.length === 0) {
      return Response.json({
        ok: false,
        error: "user_not_found"
      }, {
        status: 404,
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-store'
        }
      });
    }

    const targetProfile = targetProfiles[0];

    // Update NDA status
    await base44.asServiceRole.entities.Profile.update(targetProfile.id, {
      nda_accepted: !!accepted,
      nda_accepted_at: accepted ? (targetProfile.nda_accepted_at || new Date().toISOString()) : null,
      nda_version: accepted ? (targetProfile.nda_version || "v1.0") : targetProfile.nda_version
    });

    return Response.json({
      ok: true,
      userId,
      accepted: !!accepted
    }, {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'no-store'
      }
    });

  } catch (error) {
    console.error('Admin NDA set error:', error);
    return Response.json({
      ok: false,
      error: error.message
    }, {
      status: 500,
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'no-store'
      }
    });
  }
});