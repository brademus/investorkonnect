import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import { ensureProfile } from './ensureProfile.js';

Deno.serve(async (req) => {
  const headers = {
    'Content-Type': 'application/json',
    'Cache-Control': 'no-store, no-cache, must-revalidate'
  };

  try {
    const base44 = createClientFromRequest(req);
    
    // Get authenticated user
    let user;
    try {
      user = await base44.auth.me();
    } catch (authError) {
      console.error('‚ùå [OnboardingComplete] Auth failed:', authError);
      return Response.json({ 
        ok: false, 
        error: 'not_authenticated',
        message: 'Please sign in to continue'
      }, { status: 401, headers });
    }

    if (!user || !user.email) {
      console.error('‚ùå [OnboardingComplete] No user or email');
      return Response.json({ 
        ok: false,
        error: 'not_authenticated',
        message: 'User not found'
      }, { status: 401, headers });
    }

    console.log('‚úÖ [OnboardingComplete] User authenticated:', user.email);

    // Parse body
    let payload = {};
    try {
      const bodyText = await req.text();
      console.log('üì• [OnboardingComplete] Raw body:', bodyText);
      
      if (bodyText && bodyText.trim()) {
        payload = JSON.parse(bodyText);
        console.log('üì• [OnboardingComplete] Parsed payload:', payload);
      } else {
        console.error('‚ùå [OnboardingComplete] Empty body');
        return Response.json({ 
          ok: false,
          error: 'empty_body',
          message: 'No data provided'
        }, { status: 400, headers });
      }
    } catch (parseError) {
      console.error('‚ùå [OnboardingComplete] Body parse error:', parseError);
      return Response.json({ 
        ok: false,
        error: 'invalid_json',
        message: 'Invalid data format'
      }, { status: 400, headers });
    }

    // Ensure profile exists
    let profile;
    try {
      profile = await ensureProfile(base44, user);
      console.log('‚úÖ [OnboardingComplete] Profile found/created:', profile.id);
    } catch (ensureError) {
      console.error('‚ùå [OnboardingComplete] ensureProfile failed:', ensureError);
      return Response.json({ 
        ok: false,
        error: 'profile_load_failed',
        message: 'Could not load your profile'
      }, { status: 500, headers });
    }

    // Build update data - MAP ALL FIELDS
    const updateData = {};
    
    // Full Name (REQUIRED)
    if (payload.full_name && payload.full_name.trim()) {
      updateData.full_name = payload.full_name.trim();
      console.log('  ‚Üí full_name:', updateData.full_name);
    } else {
      console.error('‚ùå [OnboardingComplete] Missing full_name');
      return Response.json({ 
        ok: false,
        error: 'missing_full_name',
        message: 'Full name is required'
      }, { status: 400, headers });
    }
    
    // User Type / Role (REQUIRED)
    if (payload.role && payload.role.trim()) {
      updateData.user_type = payload.role.trim();
      console.log('  ‚Üí user_type:', updateData.user_type);
    } else {
      console.error('‚ùå [OnboardingComplete] Missing role');
      return Response.json({ 
        ok: false,
        error: 'missing_role',
        message: 'Account type is required'
      }, { status: 400, headers });
    }
    
    // Company (OPTIONAL)
    if (payload.company !== undefined) {
      updateData.company = payload.company.trim() || null;
      console.log('  ‚Üí company:', updateData.company);
    }
    
    // Phone (OPTIONAL)
    if (payload.phone !== undefined) {
      updateData.phone = payload.phone.trim() || null;
      console.log('  ‚Üí phone:', updateData.phone);
    }
    
    // Accreditation (OPTIONAL)
    if (payload.accreditation !== undefined) {
      updateData.accreditation = payload.accreditation.trim() || null;
      console.log('  ‚Üí accreditation:', updateData.accreditation);
    }
    
    // Goals (REQUIRED)
    if (payload.goals && payload.goals.trim()) {
      updateData.goals = payload.goals.trim();
      console.log('  ‚Üí goals:', updateData.goals);
    } else {
      console.error('‚ùå [OnboardingComplete] Missing goals');
      return Response.json({ 
        ok: false,
        error: 'missing_goals',
        message: 'Goals are required'
      }, { status: 400, headers });
    }

    // Markets (REQUIRED - at least one)
    if (payload.markets !== undefined) {
      if (Array.isArray(payload.markets)) {
        updateData.markets = payload.markets.filter(Boolean);
      } else if (typeof payload.markets === 'string') {
        updateData.markets = payload.markets.split(',').map(s => s.trim()).filter(Boolean);
      } else {
        updateData.markets = [];
      }
      
      if (updateData.markets.length === 0) {
        console.error('‚ùå [OnboardingComplete] Missing markets');
        return Response.json({ 
          ok: false,
          error: 'missing_markets',
          message: 'At least one market is required'
        }, { status: 400, headers });
      }
      
      console.log('  ‚Üí markets:', updateData.markets);
    } else {
      console.error('‚ùå [OnboardingComplete] Missing markets');
      return Response.json({ 
        ok: false,
        error: 'missing_markets',
        message: 'Markets are required'
      }, { status: 400, headers });
    }

    // CRITICAL: Mark onboarding as complete
    const wantsComplete = payload.complete === true || payload.complete === 'true';
    
    if (wantsComplete) {
      if (!profile.onboarding_completed_at) {
        updateData.onboarding_completed_at = new Date().toISOString();
        console.log('‚úÖ [OnboardingComplete] Marking complete:', updateData.onboarding_completed_at);
      } else {
        console.log('‚ÑπÔ∏è [OnboardingComplete] Already completed at:', profile.onboarding_completed_at);
      }
    } else {
      console.log('‚ÑπÔ∏è [OnboardingComplete] Not marking as complete (complete flag not set)');
    }

    console.log('üì§ [OnboardingComplete] Updating profile with:', JSON.stringify(updateData, null, 2));

    // Update profile using service role (admin access)
    let updatedProfile;
    try {
      updatedProfile = await base44.asServiceRole.entities.Profile.update(
        profile.id, 
        updateData
      );
      
      console.log('‚úÖ [OnboardingComplete] Profile updated successfully!');
      console.log('   Profile ID:', updatedProfile.id);
      console.log('   Full name:', updatedProfile.full_name);
      console.log('   User type:', updatedProfile.user_type);
      console.log('   Markets:', updatedProfile.markets);
      console.log('   Company:', updatedProfile.company);
      console.log('   Phone:', updatedProfile.phone);
      console.log('   Goals:', updatedProfile.goals);
      console.log('   Completed at:', updatedProfile.onboarding_completed_at);
      
    } catch (updateError) {
      console.error('‚ùå [OnboardingComplete] Profile update failed:', updateError);
      console.error('   Error name:', updateError.name);
      console.error('   Error message:', updateError.message);
      console.error('   Error stack:', updateError.stack);
      
      return Response.json({ 
        ok: false,
        error: 'update_failed',
        message: 'Failed to save profile: ' + updateError.message,
        details: updateError.message
      }, { status: 500, headers });
    }

    // Verify the update actually worked
    try {
      const verifyProfile = await base44.asServiceRole.entities.Profile.filter({ id: profile.id });
      if (verifyProfile && verifyProfile.length > 0) {
        const savedProfile = verifyProfile[0];
        console.log('üîç [OnboardingComplete] Verification - Profile after save:');
        console.log('   Full name:', savedProfile.full_name);
        console.log('   User type:', savedProfile.user_type);
        console.log('   Markets:', savedProfile.markets);
        console.log('   Completed:', savedProfile.onboarding_completed_at);
      }
    } catch (verifyError) {
      console.warn('‚ö†Ô∏è [OnboardingComplete] Could not verify save:', verifyError.message);
    }

    const isCompleted = !!(updatedProfile.onboarding_completed_at);

    return Response.json({ 
      ok: true,
      success: true,
      completed: isCompleted,
      userId: user.id,
      profileId: profile.id,
      completedAt: updatedProfile.onboarding_completed_at,
      profile: {
        id: updatedProfile.id,
        full_name: updatedProfile.full_name,
        user_type: updatedProfile.user_type,
        markets: updatedProfile.markets,
        company: updatedProfile.company,
        phone: updatedProfile.phone,
        goals: updatedProfile.goals,
        accreditation: updatedProfile.accreditation,
        onboarding_completed_at: updatedProfile.onboarding_completed_at
      }
    }, { status: 200, headers });

  } catch (error) {
    console.error('‚ùå [OnboardingComplete] Unexpected error:', error);
    console.error('   Name:', error.name);
    console.error('   Message:', error.message);
    console.error('   Stack:', error.stack);
    
    return Response.json({ 
      ok: false,
      error: 'internal_error',
      message: 'An unexpected error occurred: ' + error.message,
      details: error.stack
    }, { status: 500, headers });
  }
});