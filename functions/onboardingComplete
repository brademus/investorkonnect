import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import { ensureProfile } from './ensureProfile.js';

Deno.serve(async (req) => {
  const headers = {
    'Content-Type': 'application/json',
    'Cache-Control': 'no-store, no-cache, must-revalidate'
  };

  try {
    const base44 = createClientFromRequest(req);
    
    // Get authenticated user
    let user;
    try {
      user = await base44.auth.me();
    } catch (authError) {
      console.error('‚ùå [OnboardingComplete] Auth failed:', authError);
      return Response.json({ 
        ok: false, 
        completed: false,
        error: 'not_authenticated' 
      }, { status: 401, headers });
    }

    if (!user || !user.email) {
      console.error('‚ùå [OnboardingComplete] No user or email');
      return Response.json({ 
        ok: false,
        completed: false,
        error: 'not_authenticated' 
      }, { status: 401, headers });
    }

    console.log('‚úÖ [OnboardingComplete] User authenticated:', user.email);

    // Parse body
    let payload = {};
    try {
      const bodyText = await req.text();
      console.log('üì• [OnboardingComplete] Raw body:', bodyText);
      
      if (bodyText && bodyText.trim()) {
        payload = JSON.parse(bodyText);
        console.log('üì• [OnboardingComplete] Parsed payload:', payload);
      }
    } catch (parseError) {
      console.error('‚ùå [OnboardingComplete] Body parse error:', parseError);
      return Response.json({ 
        ok: false,
        completed: false,
        error: 'invalid_json' 
      }, { status: 400, headers });
    }

    // Ensure profile exists
    let profile;
    try {
      profile = await ensureProfile(base44, user);
      console.log('‚úÖ [OnboardingComplete] Profile found/created:', profile.id);
    } catch (ensureError) {
      console.error('‚ùå [OnboardingComplete] ensureProfile failed:', ensureError);
      return Response.json({ 
        ok: false,
        completed: false,
        error: 'profile_create_failed' 
      }, { status: 500, headers });
    }

    // Build update data
    const updateData = {};
    
    // Map form fields to profile fields
    if (payload.full_name) {
      updateData.full_name = payload.full_name.trim();
      console.log('  ‚Üí full_name:', updateData.full_name);
    }
    
    if (payload.role) {
      updateData.user_type = payload.role;
      console.log('  ‚Üí user_type:', updateData.user_type);
    }
    
    if (payload.company !== undefined) {
      updateData.company = payload.company.trim() || null;
      console.log('  ‚Üí company:', updateData.company);
    }
    
    if (payload.phone !== undefined) {
      updateData.phone = payload.phone.trim() || null;
      console.log('  ‚Üí phone:', updateData.phone);
    }
    
    if (payload.accreditation !== undefined) {
      updateData.accreditation = payload.accreditation.trim() || null;
      console.log('  ‚Üí accreditation:', updateData.accreditation);
    }
    
    if (payload.goals !== undefined) {
      updateData.goals = payload.goals.trim() || null;
      console.log('  ‚Üí goals:', updateData.goals);
    }

    // Handle markets array
    if (payload.markets !== undefined) {
      if (Array.isArray(payload.markets)) {
        updateData.markets = payload.markets.filter(Boolean);
      } else if (typeof payload.markets === 'string') {
        updateData.markets = payload.markets.split(',').map(s => s.trim()).filter(Boolean);
      }
      console.log('  ‚Üí markets:', updateData.markets);
    }

    // Check if we should mark onboarding complete
    const wantsComplete = payload.complete === true || payload.complete === 'true';
    
    if (wantsComplete && !profile.onboarding_completed_at) {
      updateData.onboarding_completed_at = new Date().toISOString();
      console.log('‚úÖ [OnboardingComplete] Marking complete:', updateData.onboarding_completed_at);
    } else if (wantsComplete) {
      console.log('‚ÑπÔ∏è [OnboardingComplete] Already completed at:', profile.onboarding_completed_at);
    }

    console.log('üì§ [OnboardingComplete] Updating profile with:', updateData);

    // Update profile
    let updatedProfile;
    try {
      updatedProfile = await base44.asServiceRole.entities.Profile.update(
        profile.id, 
        updateData
      );
      console.log('‚úÖ [OnboardingComplete] Profile updated successfully!');
      console.log('   Profile ID:', updatedProfile.id);
      console.log('   Full name:', updatedProfile.full_name);
      console.log('   User type:', updatedProfile.user_type);
      console.log('   Markets:', updatedProfile.markets);
      console.log('   Completed at:', updatedProfile.onboarding_completed_at);
    } catch (updateError) {
      console.error('‚ùå [OnboardingComplete] Profile update failed:', updateError);
      console.error('   Error details:', updateError.message);
      return Response.json({ 
        ok: false,
        completed: false,
        error: 'update_failed',
        details: updateError.message
      }, { status: 500, headers });
    }

    const isCompleted = !!(updatedProfile.onboarding_completed_at);

    return Response.json({ 
      ok: true,
      completed: isCompleted,
      userId: user.id,
      profileId: profile.id,
      completedAt: updatedProfile.onboarding_completed_at,
      profile: {
        full_name: updatedProfile.full_name,
        user_type: updatedProfile.user_type,
        markets: updatedProfile.markets,
        company: updatedProfile.company,
        phone: updatedProfile.phone
      }
    }, { status: 200, headers });

  } catch (error) {
    console.error('‚ùå [OnboardingComplete] Unexpected error:', error);
    console.error('   Stack:', error.stack);
    return Response.json({ 
      ok: false,
      completed: false,
      error: 'internal_error',
      message: error.message
    }, { status: 500, headers });
  }
});